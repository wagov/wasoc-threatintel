{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        },
        "ruleId": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
            "description": "The unique guid for this Analytics Rule"
            }
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/', parameters('ruleId'))]",
            "name": "[concat(parameters('workspace'), parameters('ruleId'))]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2023-12-01-preview",
            "properties": {
                "displayName": "[WASOC-Intelligence] Sign-in attempts from known User-Agent related to phishing attack",
                "description": "The rule detects sign-in attempts from known user-agent related to phishing activity.",
                "severity": "High",
                "enabled": true,
                "query": "let dt_lookBack = 1d;\nlet ioc_lookBack = 30d;\nlet TI = ThreatIntelIndicators\n    | where TimeGenerated >= ago(ioc_lookBack)\n    //Use only WASOC-Government-ISAC feed\n    | where SourceSystem == \"WASOC-Government-ISAC\" and Tags contains \"phishing\"\n    | extend IndicatorType = replace(@\"\\[|\\]|\\\"\"\", \"\", tostring(split(ObservableKey, \":\", 0)))\n    | where IndicatorType == \"user-agent\"\n    | extend UserAgent_ = tolower(ObservableValue)\n    | extend IndicatorId = tostring(split(Id, \"--\")[2])\n    | summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by Id, ObservableValue;\nlet Signin_Logs_ = SigninLogs\n    | where TimeGenerated >= ago(dt_lookBack)\n    | extend UserAgent_s = tolower(UserAgent)\n    | extend FailureOrSuccess = iff(ResultType in (0, 50055, 50057, 50011, 50155, 50105, 50129, 50133, 50140, 50005, 50074, 50076, 50079, 50155, 50173, 50158, 50072, 50074, 50097, 50125, 53003, 53000, 53001, 50129, 65001, 70043, 70044, 500121, 700016), \"Success\", \"Failure\") //WASOC definition\n    | extend UserPrincipalName_ = UserPrincipalName\n    | project-rename Signin_Logs_TimeGenerated = TimeGenerated;\nTI\n| join kind=inner Signin_Logs_ on $left.UserAgent_ == $right.UserAgent_s\n| where IsActive and (ValidUntil > now() or isempty(ValidUntil))\n| extend Description = tostring(parse_json(Data).description)\n| extend TrafficLightProtocolLevel = tostring(parse_json(AdditionalFields).TLPLevel)\n| where Description !contains_cs \"State: inactive;\" and Description !contains_cs \"State: falsepos;\"\n| project-reorder *, IsActive, Tags, TrafficLightProtocolLevel, UserAgent_, Type\n| extend Country = tostring(LocationDetails.countryOrRegion)\n|extend Name = tostring(split(UserPrincipalName_, '@', 0)[0]), UPNSuffix = tostring(split(UserPrincipalName_, '@', 1)[0])\n| project\n    Signin_Logs_TimeGenerated,\n    IndicatorId,\n    IndicatorType,\n    Name,\n    UPNSuffix,\n    UserPrincipalName_,\n    UserAgent,\n    Confidence,\n    Description,\n    FailureOrSuccess,\n    Tags,\n    TrafficLightProtocolLevel,\n    OperationName,\n    ResultType,\n    ResultSignature,\n    ResultDescription,\n    AppDisplayName,\n    ClientAppUsed,\n    IPAddress,\n    ASN = AutonomousSystemNumber,\n    Country,\n    SourceSystem,\n    Type",
                "queryFrequency": "PT1H",
                "queryPeriod": "P14D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": [
                    "InitialAccess",
                    "CredentialAccess"
                ],
                "techniques": [
                    "T1078",
                    "T1110"
                ],
                "subTechniques": [
                    "T1078.004",
                    "T1110.001"
                ],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": true,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "P1D",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "AlertPerResult"
                },
                "alertDetailsOverride": {
                    "alertDisplayNameFormat": "[WASOC-Intelligence] Sign-in attempts from known User-Agent {{UserAgent}} related to phishing attack",
                    "alertDescriptionFormat": "The rules detects successful sign-ins from known suspicious/malicious User-Agents.\n<br>\nTLP: {{TrafficLightProtocolLevel}} \n<br>\nIOC Description: {{Description}} \n<br>\nIOC Value: {{UserAgent}}",
                    "alertDynamicProperties": []
                },
                "customDetails": {
                    "UserAgent": "UserAgent",
                    "ASN": "ASN"
                },
                "entityMappings": [
                    {
                        "entityType": "IP",
                        "fieldMappings": [
                            {
                                "identifier": "Address",
                                "columnName": "IPAddress"
                            }
                        ]
                    },
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "UserPrincipalName_"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "Name"
                            },
                            {
                                "identifier": "UPNSuffix",
                                "columnName": "UPNSuffix"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": null
            }
        }
    ]
}